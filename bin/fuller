#!/usr/bin/env node

"use strict";
let fs = require("fs");
let path = require("path");
let args = require("args");
let Fuller = require("../lib");
let rxReserved = require("../lib/tools/plan").rxReserved;
let defaultOpts = require("../lib/defaults");

let planFile = path.join(process.cwd(), "plan.js");
if (!fs.existsSync(planFile)) {
	console.log("Error: can\'t find a plan");
	process.exit(1);
}

let task, runTask;
let plan = require(planFile);

for(task in plan) {
	if(rxReserved.test(task) === -1) {
		defaultOpts.push({
			name: task,
			type: "bool",
			defaultValue: false
		});
	}
}

let options = args.Options.parse(defaultOpts);

try {
	options = args.parse(options);
} catch (err) {
	console.log(options.getHelp());
	process.exit(1);
}

for(task in plan) {
	if(task !== "dev" && options[task]) {
		runTask = task;
		break;
	}
}

process.on("SIGINT", function() {
	process.exit();
});

let fuller = new Fuller("plan.js", runTask, options);
